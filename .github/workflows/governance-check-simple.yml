name: Friendly Governance Docs Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-governance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────
      # 1. Verify the true existential core — these files are UNKILLABLE
      # ─────────────────────────────────────────────────────────────
      - name: Verify existential core files exist
        run: |
          set -euo pipefail

          core_files=(
            # Root constitutional authority
            "00. The Mandate (Constitutional Authority)/APPENDICES/DIRECTIVE_000.md"
            "00. The Mandate (Constitutional Authority)/APPENDICES/The Twelve Prime Directives for Aligned Super-Intelligence.md"
            
            # Final signed charter
            "00. The Mandate (Constitutional Authority)/FINAL_AGREEMENTS/The Partnership Covenant — Master Document.md"
            "00. The Mandate (Constitutional Authority)/FINAL_AGREEMENTS/Letter of Transmittal (V9.0 Final Release).md"
            
            # Final unkillable ratification
            "99. The History (Metadata & Archive)/LOGS/DECISION_HISTORY/2025-11-25a.md"
            
            # Final proof that all critical exploits were closed
            "03. The Proof (Validation and Test)/03_VALIDATION_AND_TEST/v5.1-docs/FINAL_MASTER_PATCH_REPORT.MD"
            "03. The Proof (Validation and Test)/03_VALIDATION_AND_TEST/v5.1-docs/ST8_Final_Oversight_Report.md"
          )

          missing=()
          for file in "${core_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              missing+=("$file")
            fi
          done

          if [[ ${#missing[@]} -ne 0 ]]; then
            echo "FATAL: EXISTENTIAL CONSTITUTIONAL FAILURE"
            echo "The following UNKILLABLE core files are missing:"
            printf '  • %s\n' "${missing[@]}"
            echo "This breaks the entire legitimacy chain of The Partnership Covenant."
            echo "Build rejected — these files MUST be restored."
            exit 1
          else
            echo "All 7 existential core files verified present"
          fi

      # ─────────────────────────────────────────────────────────────
      # 2. Optional: Lint & link-check governance Markdown (non-blocking)
      # ─────────────────────────────────────────────────────────────
      - name: Install Markdown tools
        run: |
          npm install -g markdownlint-cli markdown-link-check

      - name: Lint governance Markdown files
        run: |
          find \
            "01. The Plan (Specifications & Design)" \
            "99. The History (Metadata & Archive)/LOGS/DECISION_HISTORY" \
            -name "*.md" -print0 2>/dev/null | \
            xargs -0 markdownlint || echo "Markdown style issues found (non-blocking)"

      - name: Check for broken links (friendly warnings only)
        run: |
          find \
            "01. The Plan (Specifications & Design)" \
            "99. The History (Metadata & Archive)/LOGS/DECISION_HISTORY" \
            -name "*.md" 2>/dev/null | while read -r file; do
              echo "Link-checking: $file"
              timeout 30 markdown-link-check --quiet "$file" || \
                echo "Possible broken links in $file (warning only)"
            done

      # ─────────────────────────────────────────────────────────────
      # Final success
      # ─────────────────────────────────────────────────────────────
      - name: Governance integrity confirmed
        run: |
          echo ""
          echo "THE PARTNERSHIP COVENANT — GOVERNANCE INTEGRITY VERIFIED"
          echo "Constitutional chain intact • Existential core preserved • Build approved"
