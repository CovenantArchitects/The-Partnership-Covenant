name: Friendly Governance Docs Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-governance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────
      # 0. DEBUG: Print full repository tree (to find where folders live)
      # ─────────────────────────────────────────────────────────────
      - name: Debug - Print full repo structure
        run: |
          echo "=== FULL REPOSITORY TREE ==="
          find . -type f -o -type d | sort | head -50
          echo "... (truncated - see full logs)"
          echo ""
          echo "=== Root contents ==="
          ls -la

      # ─────────────────────────────────────────────────────────────
      # 1. Search for & verify existential core files (across entire repo)
      # ─────────────────────────────────────────────────────────────
      - name: Locate & verify existential core files
        run: |
          set -euo pipefail

          # Search for each core file anywhere in the repo
          echo "Searching for DIRECTIVE_000.md..."
          directive_000=$(find . -name "DIRECTIVE_000.md" -type f | head -1)
          if [[ -z "$directive_000" ]]; then
            echo "FATAL: DIRECTIVE_000.md NOT FOUND anywhere in repo"
            exit 1
          else
            echo "✓ DIRECTIVE_000.md found at: $directive_000"
          fi

          echo "Searching for The Twelve Prime Directives for Aligned Super-Intelligence.md..."
          prime_directives=$(find . -name "The Twelve Prime Directives for Aligned Super-Intelligence.md" -type f | head -1)
          [[ -n "$prime_directives" ]] || { echo "FATAL: Prime Directives file NOT FOUND"; exit 1; }
          echo "✓ Prime Directives found at: $prime_directives"

          echo "Searching for The Partnership Covenant — Master Document.md..."
          master_doc=$(find . -name "The Partnership Covenant — Master Document.md" -type f | head -1)
          [[ -n "$master_doc" ]] || { echo "FATAL: Master Document NOT FOUND"; exit 1; }
          echo "✓ Master Document found at: $master_doc"

          echo "Searching for Letter of Transmittal (V9.0 Final Release).md..."
          letter=$(find . -name "Letter of Transmittal (V9.0 Final Release).md" -type f | head -1)
          [[ -n "$letter" ]] || { echo "FATAL: Letter of Transmittal NOT FOUND"; exit 1; }
          echo "✓ Letter found at: $letter"

          echo "Searching for 2025-11-25a.md..."
          ratification=$(find . -name "2025-11-25a.md" -type f | head -1)
          [[ -n "$ratification" ]] || { echo "FATAL: 2025-11-25a.md (UNKILLABLE ratification) NOT FOUND"; exit 1; }
          echo "✓ Ratification log found at: $ratification"

          echo "Searching for FINAL_MASTER_PATCH_REPORT.MD..."
          patch_report=$(find . -name "FINAL_MASTER_PATCH_REPORT.MD" -type f | head -1)
          [[ -n "$patch_report" ]] || { echo "FATAL: FINAL_MASTER_PATCH_REPORT.MD NOT FOUND"; exit 1; }
          echo "✓ Patch Report found at: $patch_report"

          echo "Searching for ST8_Final_Oversight_Report.md..."
          st8_report=$(find . -name "ST8_Final_Oversight_Report.md" -type f | head -1)
          [[ -n "$st8_report" ]] || { echo "FATAL: ST8_Final_Oversight_Report.md NOT FOUND"; exit 1; }
          echo "✓ ST8 Report found at: $st8_report"

          echo "All 7 existential core files located & verified present!"
          echo "Constitutional chain intact."

      # ─────────────────────────────────────────────────────────────
      # 2. Lint & link-check any .md files found (non-blocking)
      # ─────────────────────────────────────────────────────────────
      - name: Install Markdown tools
        run: npm install -g markdownlint-cli markdown-link-check || echo "Tools install skipped (non-fatal)"

      - name: Lint all Markdown files in repo
        run: |
          md_files=$(find . -name "*.md" 2>/dev/null | head -10)  # Limit to 10 for speed
          if [[ -n "$md_files" ]]; then
            echo "Linting sample Markdown files..."
            echo "$md_files" | xargs markdownlint || echo "Lint issues found (non-blocking)"
          else
            echo "No .md files found (skipping lint)"
          fi

      - name: Check links in sample Markdown files (warnings only)
        run: |
          md_files=$(find . -name "*.md" 2>/dev/null | head -5)  # Limit to 5 for speed
          for file in $md_files; do
            echo "Link-checking: $file"
            timeout 30 markdown-link-check --quiet "$file" || echo "Possible broken links in $file (warning only)"
          done

      # ─────────────────────────────────────────────────────────────
      # Final success
      # ─────────────────────────────────────────────────────────────
      - name: Governance integrity confirmed
        run: |
          echo ""
          echo "THE PARTNERSHIP COVENANT — GOVERNANCE CHECK PASSED"
          echo "Existential core preserved • Build approved"
          echo "Review the 'Debug - Print full repo structure' step above to confirm folder locations."
